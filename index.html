<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chia Ti·ªÅn ƒÇn ‚Äî Phi√™n b·∫£n 2.0</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root{--primary:#007bff;--danger:#dc3545;--card-bg:rgba(255,255,255,0.95)}
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:14px;background-size:cover;background-position:center;transition:background-image .8s}
    h1{margin:0 0 12px;font-size:20px}
    .card{background:var(--card-bg);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:12px}
    label{display:block;margin-top:8px;font-size:13px}
    input,select,button,textarea{font-family:inherit}
    input,select,textarea{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #dcdcdc;box-sizing:border-box}
    .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    button{padding:9px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-muted{background:#f3f4f6;color:#111}

    /* checkbox group */
    .checkbox-group{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .person-pill{display:flex;align-items:center;gap:8px;background:#f7f9fc;padding:8px 10px;border-radius:999px;cursor:pointer;border:1px solid #eef2f7}
    .person-pill input{width:18px;height:18px}

    /* table Excel mini */
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px;border-radius:8px;overflow:hidden}
    th,td{border:1px solid #eaeaea;padding:8px;text-align:center}
    th{background:#f6f8fa;font-weight:600}
    tr:nth-child(even){background:#fafafa}

    /* debts list */
    .debt-row{display:flex;justify-content:space-between;align-items:center;padding:8px 6px;border-bottom:1px solid #f0f0f0}
    .debt-left{font-weight:600}

    /* modal add user */
    .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{background:#fff;padding:18px;border-radius:10px;max-width:420px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal h3{margin:0 0 8px}
    .modal .warn{display:flex;gap:8px;align-items:center;color:var(--danger);font-weight:700}
    .similar-list{margin-top:8px;padding:8px;background:#fff7f7;border-radius:8px;border:1px solid #f5d6d6}
    .small{font-size:13px;color:#666}

    /* celebration popup */
    #celebration{position:fixed;left:50%;top:22%;transform:translateX(-50%);background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);display:none;z-index:1000}

    @media (max-width:600px){.person-pill{font-size:13px;padding:6px}}
  </style>
</head>
<body>
  <h1>üçΩÔ∏è Chia Ti·ªÅn ƒÇn ‚Äî Phi√™n b·∫£n 2.0</h1>

  <!-- Form -->
  <div class="card" id="formCard">
    <label>Ng√†y chi</label>
    <input id="date" type="date">

    <label>M·ª•c ƒë√≠ch</label>
    <input id="purpose" list="purposeList" placeholder="V√≠ d·ª•: L·∫©u, C∆°m tr∆∞a...">
    <datalist id="purposeList"></datalist>

    <label>Ng∆∞·ªùi tr·∫£</label>
    <select id="payer"><option value="">-- Ch·ªçn --</option></select>

    <label>S·ªë ti·ªÅn (ngh√¨n)</label>
    <input id="amount" type="number" min="0" step="1">

    <label>Nh·ªØng ng∆∞·ªùi tham gia</label>
    <div class="checkbox-group" id="participantsGroup"></div>

    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button class="btn-primary" id="addExpenseBtn">‚ûï Th√™m kho·∫£n chi</button>
      <button class="btn-muted" id="openAddUserBtn">‚ûï Th√™m ng∆∞·ªùi m·ªõi</button>
      <button class="btn-danger" id="clearBtn">üóëÔ∏è X√≥a to√†n b·ªô</button>
    </div>
  </div>

  <!-- Details table -->
  <div class="card">
    <h2>üìÖ Danh s√°ch chi ti·∫øt</h2>
    <table>
      <thead><tr><th>Ng√†y</th><th>M·ª•c ƒë√≠ch</th><th>Ng∆∞·ªùi tr·∫£</th><th>S·ªë ti·ªÅn (k)</th><th>Ng∆∞·ªùi tham gia</th></tr></thead>
      <tbody id="detailsBody"></tbody>
    </table>
  </div>

  <!-- Debts -->
  <div class="card">
    <h2>üìä Danh s√°ch n·ª£</h2>
    <div id="debts"></div>
  </div>

  <!-- Modal Add User -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>‚ûï Th√™m ng∆∞·ªùi m·ªõi</h3>
      <div class="small">Nh·∫≠p t√™n ng∆∞·ªùi (v√≠ d·ª•: Ti√™n)</div>
      <input id="newUserInput" placeholder="Nh·∫≠p t√™n..." style="margin-top:8px">
      <div id="similarContainer" style="margin-top:10px;display:none">
        <div class="warn"><span style="font-size:20px">‚ö†Ô∏è</span> T√™n g·∫ßn gi·ªëng ƒë√£ t·ªìn t·∫°i</div>
        <div class="similar-list" id="similarList"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="cancelAddUser">H·ªßy</button>
        <button class="btn-primary" id="confirmAddUser">L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- Celebration -->
  <div id="celebration">üéâ ƒê√£ thanh to√°n! C·∫£m ∆°n b·∫°n! üéâ</div>

  <script>
    // ---------- Firebase config (your project) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCQCqTF0PQ7FW4KE1w-u_VsyOVkBWIWy4w",
      authDomain: "ez-campuchia-money.firebaseapp.com",
      databaseURL: "https://ez-campuchia-money-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ez-campuchia-money",
      storageBucket: "ez-campuchia-money.appspot.com",
      messagingSenderId: "718764161113",
      appId: "1:718764161113:web:7bcb4d86b7add1f4ced948"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- utility: normalize (remove diacritics, lower) ----------
    function normalizeName(s){
      return s.normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/[^\w\s]/g,'').toLowerCase().trim();
    }

    // simple levenshtein distance
    function levenshtein(a,b){
      a = a||''; b = b||''; const m = a.length, n = b.length; if(!m) return n; if(!n) return m;
      const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1]?0:1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }

    // ---------- app state ----------
    let users = []; // array of {key,id,name,normalized,createdAt}
    let purposes = []; // array of {key,name,ts}

    // ---------- DOM refs ----------
    const payerSelect = document.getElementById('payer');
    const participantsGroup = document.getElementById('participantsGroup');
    const detailsBody = document.getElementById('detailsBody');
    const debtsDiv = document.getElementById('debts');
    const purposeList = document.getElementById('purposeList');

    // ---------- load users & render UI ----------
    function renderUsers(){
      // populate payer select
      payerSelect.innerHTML = '<option value="">-- Ch·ªçn --</option>' + users.map(u=>`<option value="${escapeHtml(u.name)}">${escapeHtml(u.name)}</option>`).join('');
      // populate participants pills
      participantsGroup.innerHTML = '';
      users.forEach(u=>{
        const lbl = document.createElement('label'); lbl.className='person-pill';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.value=u.name;
        lbl.appendChild(cb); lbl.appendChild(document.createTextNode(u.name));
        participantsGroup.appendChild(lbl);
      });
    }

    // escape HTML text
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[s]); }

    // ---------- Users CRUD on Firebase ----------
    const usersRef = db.ref('users');
    usersRef.on('value', snap=>{
      const obj = snap.val() || {};
      users = Object.entries(obj).map(([k,v])=>({key:k,name:v.name,normalized:v.normalized,createdAt:v.createdAt||0}));
      users.sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
      renderUsers();
    });

    function addUserToFirebase(displayName){
      const normalized = normalizeName(displayName);
      const payload = { name: displayName, normalized, createdAt: Date.now() };
      usersRef.push(payload);
    }

    // ---------- Purposes list (datalist) ----------
    const purposesRef = db.ref('purposes');
    purposesRef.on('value', snap=>{
      const obj = snap.val() || {};
      // convert to array sorted by ts desc
      purposes = Object.entries(obj).map(([k,v])=>({key:k,name:v.name,ts:v.ts||0}));
      purposes.sort((a,b)=> b.ts - a.ts);
      renderPurposes();
    });

    function renderPurposes(){
      purposeList.innerHTML = purposes.map(p=>`<option value="${escapeHtml(p.name)}">`).join('');
    }

    async function savePurposeIfNew(name){
      if(!name) return;
      const normalized = name.trim();
      const exists = purposes.find(p=>p.name.toLowerCase()===normalized.toLowerCase());
      if(exists){
        // update ts
        db.ref('purposes/'+exists.key+'/ts').set(Date.now());
        return;
      }
      // add new
      const newRef = purposesRef.push();
      await newRef.set({ name: normalized, ts: Date.now() });

      // trim to latest 20
      const snap = await purposesRef.get(); const all = snap.val() || {};
      const arr = Object.entries(all).map(([k,v])=>({k,name:v.name,ts:v.ts||0}));
      arr.sort((a,b)=> b.ts - a.ts);
      if(arr.length>20){
        const toRemove = arr.slice(20);
        toRemove.forEach(x=> purposesRef.child(x.k).remove());
      }
    }

    // ---------- Expenses handling ----------
    const expensesRef = db.ref('expenses');
    function addExpenseObj(obj){ expensesRef.push(obj); }

    // ---------- render expenses & debts ----------
    expensesRef.on('value', snapshot=>{
      const obj = snapshot.val() || {};
      const rows = Object.entries(obj).map(([k,v])=>({key:k,...v}));
      rows.sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));

      // render details table
      detailsBody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const purposeLabel = r.purpose + (r.settlement? ' (Tr·∫£ n·ª£)': '');
        tr.innerHTML = `<td>${escapeHtml(r.date||'')}</td><td>${escapeHtml(purposeLabel)}</td><td>${escapeHtml(r.payer||'')}</td><td>${r.amount!=null?escapeHtml(r.amount):''}</td><td>${(r.participants||[]).map(escapeHtml).join(', ')}</td>`;
        detailsBody.appendChild(tr);
      });

      // compute debts with floor logic and settlement handling
      let debts = {};
      rows.forEach(r=>{
        if(!Array.isArray(r.participants)) return;
        if(r.settlement===true && r.participants.length===2){
          const from = r.payer; const to = r.participants.find(p=>p!==from);
          if(!from||!to) return;
          // settlement subtract full amount
          debts[`${from}->${to}`] = (debts[`${from}->${to}`]||0) + (-1 * Number(r.amount));
          debts[`${to}->${from}`] = (debts[`${to}->${from}`]||0) + Number(r.amount);
          return;
        }
        const amount = Number(r.amount)||0; const cnt = r.participants.length||1;
        const rawShare = amount / cnt; const share = Math.floor(rawShare); // floor per requirement
        r.participants.forEach(p=>{
          if(p===r.payer) return;
          debts[`${p}->${r.payer}`] = (debts[`${p}->${r.payer}`]||0) + share;
          debts[`${r.payer}->${p}`] = (debts[`${r.payer}->${p}`]||0) - share;
        });
      });

      // normalize and render positive debts
      for(const k in debts) if(Math.abs(debts[k])<1) debts[k]=0;
      debtsDiv.innerHTML = '';
      const entries = Object.entries(debts).filter(([k,v])=> v>0).sort((a,b)=> b[1]-a[1]);
      if(entries.length===0){ debtsDiv.innerHTML = '<p class="small">Ch∆∞a c√≥ n·ª£ (0)</p>'; }
      else{
        entries.forEach(([key,val])=>{
          const [from,to] = key.split('->'); const amount = Math.round(val);
          const row = document.createElement('div'); row.className='debt-row';
          const left = document.createElement('div'); left.className='debt-left'; left.textContent = `${from} ‚Üí ${to}: n·ª£ ${amount}k`;
          const right = document.createElement('div');
          const payBtn = document.createElement('button'); payBtn.className='delete-btn'; payBtn.textContent='‚ùå Thanh to√°n';
          payBtn.addEventListener('click', ()=> markDebtPaid(from,to,amount));
          right.appendChild(payBtn);
          row.appendChild(left); row.appendChild(right); debtsDiv.appendChild(row);
        });
      }
    });

    // ---------- mark debt paid (creates settlement) ----------
    function markDebtPaid(from,to,amount){
      if(!confirm(`X√°c nh·∫≠n ${from} ƒë√£ tr·∫£ ${amount}k cho ${to}?`)) return;
      const today = new Date().toISOString().slice(0,10);
      const obj = { date: today, purpose: 'Tr·∫£ n·ª£', payer: from, amount: amount, participants: [from,to], settlement: true, createdAt: Date.now() };
      addExpenseObj(obj);

      // celebration
      showCelebration();
    }

    // ---------- celebration UI ----------
    function showCelebration(){
      const popup = document.getElementById('celebration'); popup.style.display='block';
      confetti({particleCount:140,spread:90,origin:{y:0.6}});
      setTimeout(()=>{ popup.style.display='none'; },2500);
    }

    // ---------- add expense (form) ----------
    document.getElementById('addExpenseBtn').addEventListener('click', async ()=>{
      const date = document.getElementById('date').value;
      const purpose = document.getElementById('purpose').value.trim();
      const payer = document.getElementById('payer').value;
      const amount = Number(document.getElementById('amount').value);
      const participants = Array.from(document.querySelectorAll('.checkbox-group input:checked')).map(i=>i.value);
      if(!date||!purpose||!payer||!amount||participants.length===0){ alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin'); return; }
      const obj = { date, purpose, payer, amount, participants, createdAt: Date.now() };
      addExpenseObj(obj);
      await savePurposeIfNew(purpose); // save purpose suggestions, trimming to 20
      // feedback
      const b = document.getElementById('addExpenseBtn'); b.textContent='‚úÖ ƒê√£ th√™m!'; b.disabled=true; setTimeout(()=>{ b.textContent='‚ûï Th√™m kho·∫£n chi'; b.disabled=false; },1200);
      document.getElementById('purpose').value=''; document.getElementById('amount').value=''; document.querySelectorAll('.checkbox-group input').forEach(cb=>cb.checked=false);
    });

    // ---------- open add user modal ----------
    const modalBackdrop = document.getElementById('modalBackdrop');
    document.getElementById('openAddUserBtn').addEventListener('click', ()=>{
      document.getElementById('newUserInput').value=''; document.getElementById('similarContainer').style.display='none'; modalBackdrop.style.display='flex'; document.getElementById('newUserInput').focus();
    });

    document.getElementById('cancelAddUser').addEventListener('click', ()=> modalBackdrop.style.display='none');

    // when typing new user, check for similar names
    document.getElementById('newUserInput').addEventListener('input', (e)=>{
      const v = e.target.value.trim(); if(!v){ document.getElementById('similarContainer').style.display='none'; return; }
      const nv = normalizeName(v);
      const sims = users.map(u=>({name:u.name,normalized:u.normalized,dist:levenshtein(nv,u.normalized)})).filter(x=> x.normalized!==nv && (x.dist<=1 || x.normalized.includes(nv) || nv.includes(x.normalized)) ).slice(0,6);
      const cont = document.getElementById('similarContainer'); const list = document.getElementById('similarList');
      if(sims.length){ list.innerHTML = sims.map(s=>`<div>${escapeHtml(s.name)} (c√°ch ${s.dist})</div>`).join(''); cont.style.display='block'; }
      else cont.style.display='none';
    });

    // confirm add user
    document.getElementById('confirmAddUser').addEventListener('click', ()=>{
      const name = document.getElementById('newUserInput').value.trim(); if(!name) return alert('Nh·∫≠p t√™n');
      const n = normalizeName(name);
      // check exact
      const existsExact = users.find(u=>u.normalized===n);
      if(existsExact){ if(!confirm(`T√™n "${existsExact.name}" ƒë√£ t·ªìn t·∫°i t∆∞∆°ng t·ª±. B·∫°n v·∫´n mu·ªën th√™m "${name}"?`)) return; }
      addUserToFirebase(name); modalBackdrop.style.display='none';
    });

    // ---------- clear all expenses (with confirm) ----------
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(confirm('X√≥a t·∫•t c·∫£ d·ªØ li·ªáu chi ti√™u (kh√¥ng ·∫£nh h∆∞·ªüng users/purposes)?')) db.ref('expenses').remove();
    });

    // ---------- helper: savePurposeIfNew already defined above ----------

    // ---------- initial default users (only if DB empty) ----------
    (async function ensureDefaultUsers(){
      const snap = await usersRef.get(); if(snap.exists()) return; 
      const defaults = ['T√∫ Anh','H·∫£i','Nam','Y·∫øn','H∆∞∆°ng kun','Phong','Minh kho','Tu·∫•n L√πn'];
      defaults.forEach(n=> usersRef.push({name:n,normalized:normalizeName(n),createdAt:Date.now()}));
    })();

    // ---------- random background per hour ----------
    (function(){ const hour=new Date().getHours(); document.body.style.backgroundImage = `url(https://source.unsplash.com/1600x900/?food,meal,dinner&sig=${hour})`; })();

  </script>
</body>
</html>
