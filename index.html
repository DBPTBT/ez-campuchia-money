<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chia Ti·ªÅn ƒÇn</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #f8f9fa; 
    }
    h1 { text-align: center; color: #2c3e50; }
    h2 { margin-top: 30px; color: #34495e; }
    form, .card { 
      background: white; 
      padding: 15px; 
      border-radius: 8px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
      margin-bottom: 20px;
    }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { 
      margin-top: 5px; 
      padding: 8px; 
      width: 100%; 
      border: 1px solid #ccc; 
      border-radius: 5px;
    }
    button { 
      margin-top: 15px; 
      padding: 10px 15px; 
      border: none; 
      border-radius: 5px; 
      background: #3498db; 
      color: white; 
      font-weight: bold; 
      cursor: pointer; 
      width: 100%;
    }
    button:hover { background: #2980b9; }
    #resetBtn { background: #e74c3c; }
    #resetBtn:hover { background: #c0392b; }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 10px; 
      background: white; 
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 10px; 
      text-align: center; 
    }
    th { background: #3498db; color: white; }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      th { display: none; }
      td { 
        text-align: right; 
        padding-left: 50%; 
        position: relative; 
      }
      td::before {
        position: absolute; 
        left: 10px; 
        top: 10px; 
        white-space: nowrap; 
        font-weight: bold;
      }
    }
  </style>
</head>
<body>
  <h1>Chia Ti·ªÅn ƒÇn</h1>

  <!-- Form nh·∫≠p d·ªØ li·ªáu -->
  <form id="expenseForm">
    <label>Ng√†y chi ti√™u:
      <input type="date" id="date" required>
    </label>
    <label>M·ª•c ƒë√≠ch:
      <input type="text" id="purpose" placeholder="ƒÇn tr∆∞a, c√† ph√™..." required>
    </label>
    <label>Ng∆∞·ªùi tr·∫£:
      <select id="payer" required>
        <option value="T√∫ Anh">T√∫ Anh</option>
        <option value="H·∫£i">H·∫£i</option>
        <option value="Nam">Nam</option>
        <option value="Y·∫øn">Y·∫øn</option>
        <option value="H∆∞∆°ng kun">H∆∞∆°ng kun</option>
        <option value="Phong">Phong</option>
        <option value="Minh kho">Minh kho</option>
      </select>
    </label>
    <label>S·ªë ti·ªÅn (ngh√¨n ƒë·ªìng):
      <input type="number" id="amount" required>
    </label>
    <label>Ng∆∞·ªùi tham gia:</label>
    <label><input type="checkbox" class="participant" value="T√∫ Anh"> T√∫ Anh</label>
    <label><input type="checkbox" class="participant" value="H·∫£i"> H·∫£i</label>
    <label><input type="checkbox" class="participant" value="Nam"> Nam</label>
    <label><input type="checkbox" class="participant" value="Y·∫øn"> Y·∫øn</label>
    <label><input type="checkbox" class="participant" value="H∆∞∆°ng kun"> H∆∞∆°ng kun</label>
    <label><input type="checkbox" class="participant" value="Phong"> Phong</label>
    <label><input type="checkbox" class="participant" value="Minh kho"> Minh kho</label>
    
    <button type="submit">‚ûï Th√™m kho·∫£n chi</button>
  </form>

  <button id="resetBtn">‚ôªÔ∏è X√≥a to√†n b·ªô d·ªØ li·ªáu</button>

  <!-- B·∫£ng n·ª£ -->
  <div class="card">
    <h2>üìä Danh s√°ch n·ª£</h2>
    <div id="debts"></div>
  </div>

  <!-- B·∫£ng chi ti√™u -->
  <div class="card">
    <h2>üìù Danh s√°ch chi ti√™u</h2>
    <div id="expensesList"></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, push, set, get, child, remove } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCQCqTF0PQ7FW4KE1w-u_VsyOVkBWIWy4w",
      authDomain: "ez-campuchia-money.firebaseapp.com",
      databaseURL: "https://ez-campuchia-money-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ez-campuchia-money",
      storageBucket: "ez-campuchia-money.firebasestorage.app",
      messagingSenderId: "718764161113",
      appId: "1:718764161113:web:7bcb4d86b7add1f4ced948"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const form = document.getElementById("expenseForm");
    const debtsDiv = document.getElementById("debts");
    const expensesList = document.getElementById("expensesList");
    const resetBtn = document.getElementById("resetBtn");

    const members = ["T√∫ Anh","H·∫£i","Nam","Y·∫øn","H∆∞∆°ng kun","Phong","Minh kho"];

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const date = document.getElementById("date").value;
      const purpose = document.getElementById("purpose").value;
      const payer = document.getElementById("payer").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const participants = Array.from(document.querySelectorAll(".participant:checked"))
                                .map(cb => cb.value);

      if (participants.length === 0) {
        alert("Ch·ªçn √≠t nh·∫•t m·ªôt ng∆∞·ªùi tham gia!");
        return;
      }

      const newExpenseRef = push(ref(db, "expenses"));
      await set(newExpenseRef, { date, purpose, payer, amount, participants });

      form.reset();
      loadDebts();
      loadExpenses();
    });

    async function loadDebts() {
      const snapshot = await get(child(ref(db), "expenses"));
      const expenses = snapshot.val() || {};

      let debts = {};
      members.forEach(a => {
        debts[a] = {};
        members.forEach(b => { if(a !== b) debts[a][b] = 0; });
      });

      Object.values(expenses).forEach(exp => {
        const share = exp.amount / exp.participants.length;
        exp.participants.forEach(person => {
          if (person !== exp.payer) {
            debts[person][exp.payer] += share;
          }
        });
      });

      members.forEach(a => {
        members.forEach(b => {
          if (a !== b) {
            const debtAB = debts[a][b];
            const debtBA = debts[b][a];
            if (debtAB > debtBA) {
              debts[a][b] = debtAB - debtBA;
              debts[b][a] = 0;
            } else {
              debts[b][a] = debtBA - debtAB;
              debts[a][b] = 0;
            }
          }
        });
      });

      let html = "<table><tr><th>Ng∆∞·ªùi n·ª£</th><th>Ng∆∞·ªùi ƒë∆∞·ª£c n·ª£</th><th>S·ªë ti·ªÅn (ngh√¨n)</th></tr>";
      members.forEach(a => {
        members.forEach(b => {
          if (a !== b && debts[a][b] > 0) {
            html += `<tr><td>${a}</td><td>${b}</td><td>${debts[a][b]}</td></tr>`;
          }
        });
      });
      html += "</table>";

      debtsDiv.innerHTML = html;
    }

    async function loadExpenses() {
      const snapshot = await get(child(ref(db), "expenses"));
      const expenses = snapshot.val() || {};

      let html = "<table><tr><th>Ng√†y</th><th>M·ª•c ƒë√≠ch</th><th>Ng∆∞·ªùi tr·∫£</th><th>S·ªë ti·ªÅn</th><th>Ng∆∞·ªùi tham gia</th></tr>";
      Object.values(expenses).forEach(exp => {
        html += `<tr>
                  <td>${exp.date}</td>
                  <td>${exp.purpose}</td>
                  <td>${exp.payer}</td>
                  <td>${exp.amount}</td>
                  <td>${exp.participants.join(", ")}</td>
                </tr>`;
      });
      html += "</table>";

      expensesList.innerHTML = html;
    }

    resetBtn.addEventListener("click", async () => {
      if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu kh√¥ng?")) {
        await remove(ref(db, "expenses"));
        debtsDiv.innerHTML = "";
        expensesList.innerHTML = "";
      }
    });

    loadDebts();
    loadExpenses();
  </script>
</body>
</html>
