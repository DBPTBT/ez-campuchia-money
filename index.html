<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chia Ti·ªÅn ƒÇn Online</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { padding: 8px; margin-top: 5px; width: 100%; box-sizing: border-box; }
    button { margin-top: 15px; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
    #submitBtn { background: #007bff; color: white; }
    #resetBtn { background: #dc3545; color: white; width: 100%; }
    #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #4CAF50; color: #fff; text-align: center;
             border-radius: 8px; padding: 12px; position: fixed; z-index: 1; left: 50%; bottom: 30px; font-size: 16px;
             box-shadow: 0 4px 6px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
    #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
  </style>
</head>
<body>
  <h1>üçΩÔ∏è Chia Ti·ªÅn ƒÇn Online</h1>

  <!-- Form nh·∫≠p chi ti√™u -->
  <div class="card">
    <form id="expenseForm">
      <label>Ng√†y chi:</label>
      <input type="date" id="date" required>
      <label>M·ª•c ƒë√≠ch:</label>
      <input type="text" id="purpose" placeholder="V√≠ d·ª•: Li√™n hoan, nh·∫≠u..." required>
      <label>Ng∆∞·ªùi tr·∫£ ti·ªÅn:</label>
      <select id="payer" required>
        <option value="">-- Ch·ªçn ng∆∞·ªùi --</option>
        <option>T√∫ Anh</option><option>H·∫£i</option><option>Nam</option>
        <option>Y·∫øn</option><option>H∆∞∆°ng kun</option><option>Phong</option><option>Minh kho</option>
      </select>
      <label>S·ªë ti·ªÅn (ngh√¨n ƒë·ªìng):</label>
      <input type="number" id="amount" required>
      <label>Nh·ªØng ng∆∞·ªùi tham gia:</label>
      <select id="participants" multiple size="7" required>
        <option>T√∫ Anh</option><option>H·∫£i</option><option>Nam</option>
        <option>Y·∫øn</option><option>H∆∞∆°ng kun</option><option>Phong</option><option>Minh kho</option>
      </select>
      <button type="submit" id="submitBtn">‚ûï Th√™m kho·∫£n chi</button>
    </form>
  </div>

  <!-- Danh s√°ch n·ª£ -->
  <div class="card">
    <h2>üìä Danh s√°ch n·ª£</h2>
    <div id="debts"></div>
  </div>

  <!-- N√∫t x√≥a to√†n b·ªô -->
  <div class="card">
    <button id="resetBtn">üóëÔ∏è X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
  </div>

  <!-- Th√¥ng b√°o nh·ªè -->
  <div id="toast">‚úÖ ƒê√£ th√™m th√†nh c√¥ng!</div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

    // Config Firebase c·ªßa b·∫°n
    const firebaseConfig = {
      apiKey: "AIzaSyCQCqTF0PQ7FW4KE1w-u_VsyOVkBWIWy4w",
      authDomain: "ez-campuchia-money.firebaseapp.com",
      databaseURL: "https://ez-campuchia-money-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ez-campuchia-money",
      storageBucket: "ez-campuchia-money.appspot.com",
      messagingSenderId: "718764161113",
      appId: "1:718764161113:web:7bcb4d86b7add1f4ced948"
    };

    // Kh·ªüi t·∫°o Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let debts = {};

    function saveDebts() {
      set(ref(db, "debts"), debts);
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.innerText = message;
      toast.className = "show";
      setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
    }

    function renderDebts() {
      const debtsDiv = document.getElementById("debts");
      debtsDiv.innerHTML = "";
      if (Object.keys(debts).length === 0) {
        debtsDiv.innerHTML = "<p>Ch∆∞a c√≥ d·ªØ li·ªáu</p>";
        return;
      }
      for (const [key, value] of Object.entries(debts)) {
        if (value !== 0) {
          const p = document.createElement("p");
          p.innerText = `${key}: ${value > 0 ? "n·ª£ " + value + "k" : "ƒë∆∞·ª£c n·ª£ " + (-value) + "k"}`;
          debtsDiv.appendChild(p);
        }
      }
    }

    // L·∫Øng nghe d·ªØ li·ªáu t·ª´ Firebase (Realtime)
    onValue(ref(db, "debts"), (snapshot) => {
      debts = snapshot.val() || {};
      renderDebts();
    });

    // X·ª≠ l√Ω th√™m kho·∫£n chi
    document.getElementById("expenseForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const date = document.getElementById("date").value;
      const purpose = document.getElementById("purpose").value;
      const payer = document.getElementById("payer").value;
      const amount = parseInt(document.getElementById("amount").value);
      const participants = Array.from(document.getElementById("participants").selectedOptions).map(o => o.value);

      if (!date || !purpose || !payer || !amount || participants.length === 0) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
      }

      const share = amount / participants.length;

      participants.forEach(person => {
        if (!debts[`${person}->${payer}`]) debts[`${person}->${payer}`] = 0;
        if (person !== payer) debts[`${person}->${payer}`] += share;
      });

      participants.forEach(person => {
        if (person !== payer) {
          const reverseKey = `${payer}->${person}`;
          if (debts[reverseKey]) {
            const minDebt = Math.min(debts[`${person}->${payer}`], debts[reverseKey]);
            debts[`${person}->${payer}`] -= minDebt;
            debts[reverseKey] -= minDebt;
          }
        }
      });

      saveDebts();

      // Hi·ªáu ·ª©ng n√∫t + popup
      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      const oldText = submitBtn.innerHTML;
      submitBtn.innerHTML = "‚úÖ ƒê√£ th√™m!";
      submitBtn.style.backgroundColor = "#28a745";
      showToast("‚úÖ ƒê√£ th√™m th√†nh c√¥ng!");
      setTimeout(() => {
        submitBtn.innerHTML = oldText;
        submitBtn.style.backgroundColor = "#007bff";
        submitBtn.disabled = false;
      }, 1500);

      document.getElementById("expenseForm").reset();
    });

    // X·ª≠ l√Ω x√≥a d·ªØ li·ªáu
    document.getElementById("resetBtn").addEventListener("click", function() {
      if (confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu kh√¥ng?")) {
        remove(ref(db, "debts"));
        showToast("üóëÔ∏è ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!");
      }
    });
  </script>
</body>
</html>
